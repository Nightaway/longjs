<!DOCTYPE html>
<html style="height: 100%">
<head>
    <meta charset="utf-8">
    <script type="text/javascript" src="torch.js"></script>
    <script type="text/javascript" src="mnist.js"></script>
</head>
<body style="height: 100%; margin: 0">
        <div id="container" style="height: 100%"></div>
        <script type="text/javascript" src="echarts.min.js"></script>
        <script type="text/javascript">
            var dom = document.getElementById("container");
            var myChart = echarts.init(dom);
            var app = {};
            option = null;
            option = {
                xAxis: {
                    type: 'category',
                    data: []
                },
                yAxis: {
                    type: 'value'
                },
                series: [{
                    data: [],
                    type: 'line'
                }]
            };
            ;

            function sigmoid(x) {
                return torch.function(torch.const(1).div(torch.const(1).add(torch.const(Math.E).pow(torch.tensor(x).minus()))));
            }

            function linear(x, w, b) {
                return torch.function(x.mul(w).add(b));
            }

            function loss(y_, y) {
                return torch.function(torch.tensor(y_).sub(torch.tensor(y)));
            }
            
            var lr = torch.tensor(0.0001);
            var w = torch.tensor(784, 1);
            w.name = "w";
            var b = torch.tensor(1);
            b.name = "b";

            for (var j=0; j<5; j++) {
            for (var i=0; i<1000; i++) {
                if (labels[i] == 0) {
                    var x = torch.tensor(images[i]);
                    var a  = linear(x, w, b);
                    a.name = "linear";
                    var y_ = sigmoid(a);
                    y_.name = "sigmoid";
                    var loss_ = loss(y_, 0);
                    loss_.name = "loss";
                    loss_.backward();
                    
                    var grad = w.grad.transpose_();
                    w.sub_(lr.mul(grad));
                    b.sub_(lr.mul(b.grad));
                    
                    if (i%50 == 0) {
                        console.log("" + i +" 0 : " + loss_.head.mat);
                        option.xAxis.data.push((j*1000)+i)
                        option.series[0].data.push(loss_.head.mat[0][0])
                    }
                } else if (labels[i] == 1) {
                    var x = torch.tensor(images[i]);
                    var a  = linear(x, w, b);
                    a.name = "linear";
                    var y_ = sigmoid(a);
                    y_.name = "sigmoid";
                    var loss_ = loss(y_, 1);
                    loss_.name = "loss";
                    loss_.backward();

                    var grad = w.grad.transpose_()
                    w.sub_(lr.mul(grad));
                    b.sub_(lr.mul(b.grad));
                    
                    if (i%50 == 0) {
                        console.log("" + i +" 1: " + loss_.head.mat);
                        option.xAxis.data.push((j*1000)+i)
                        option.series[0].data.push(loss_.head.mat[0][0]);
                    }
                }
            }
        }
        if (option && typeof option === "object") {
            console.log(option);
            myChart.setOption(option, true);
        }
        </script>
</body>
</html>